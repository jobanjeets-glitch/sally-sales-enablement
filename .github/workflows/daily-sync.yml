name: Daily Pinecone Sync

on:
  schedule:
    # Run every day at 2 AM UTC (9 PM EST / 6 PM PST)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 120 # 2 hour timeout

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Create Google credentials file
        run: echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" | base64 -d > google-credentials.json

      - name: Verify credentials file
        run: |
          if [ -f google-credentials.json ]; then
            echo "âœ“ Credentials file created"
            echo "File size: $(wc -c < google-credentials.json) bytes"
            # Validate JSON structure
            if node -e "JSON.parse(require('fs').readFileSync('google-credentials.json', 'utf8'))" 2>/dev/null; then
              echo "âœ“ Credentials file is valid JSON"
              echo "âœ“ Has 'private_key' field: $(node -e "console.log(!!JSON.parse(require('fs').readFileSync('google-credentials.json', 'utf8')).private_key)")"
            else
              echo "âœ— Credentials file is not valid JSON"
              exit 1
            fi
          else
            echo "âœ— Credentials file not found"
            exit 1
          fi

      - name: Create .env file
        run: |
          cat > .env << EOF
          PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CREDENTIALS_PATH=./google-credentials.json
          GOOGLE_DRIVE_FOLDER_ID=${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          EOF

      - name: Run sync
        id: sync
        run: |
          echo "Starting intelligent sync..."
          npm run sync-full 2>&1 | tee sync-output.log
          SYNC_EXIT=$?
          echo "exit_code=$SYNC_EXIT" >> $GITHUB_OUTPUT
          exit $SYNC_EXIT

      - name: Generate summary
        if: always()
        run: |
          echo "## ðŸ“Š Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f sync-output.log ]; then
            # Extract key metrics from log
            NEW_COUNT=$(grep -oP 'NEW files: \K\d+' sync-output.log 2>/dev/null || echo "?")
            MOD_COUNT=$(grep -oP 'MODIFIED files: \K\d+' sync-output.log 2>/dev/null || echo "?")
            UNCHANGED_COUNT=$(grep -oP 'UNCHANGED files: \K\d+' sync-output.log 2>/dev/null || echo "?")

            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$NEW_COUNT" = "0" ]; then
              echo "- âœ… **$NEW_COUNT NEW files** - All files already indexed" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ðŸ“ **$NEW_COUNT NEW files** - Indexed successfully" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$MOD_COUNT" != "0" ] && [ "$MOD_COUNT" != "?" ]; then
              echo "- ðŸ”„ **$MOD_COUNT MODIFIED files** - Updated since last sync" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… **$MOD_COUNT MODIFIED files** - No updates needed" >> $GITHUB_STEP_SUMMARY
            fi

            echo "- â­ï¸  **$UNCHANGED_COUNT UNCHANGED files** - Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show last 30 lines of detailed log
            echo "### Detailed Log (Last 30 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -30 sync-output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Full logs available in artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Upload sync log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-log-${{ github.run_number }}
          path: sync-output.log
          retention-days: 30
          if-no-files-found: ignore

      - name: Cleanup credentials
        if: always()
        run: |
          rm -f google-credentials.json
          rm -f .env

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Sync job failed. Check the logs for details."
