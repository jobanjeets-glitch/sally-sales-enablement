name: Daily Pinecone Sync

on:
  schedule:
    # Run every day at 2 AM UTC (9 PM EST / 6 PM PST)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 120 # 2 hour timeout

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Create Google credentials file
        env:
          GOOGLE_CREDS: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          printf '%s\n' "$GOOGLE_CREDS" > google-credentials.json

      - name: Verify credentials file
        run: |
          if [ -f google-credentials.json ]; then
            echo "‚úì Credentials file created"
            echo "File size: $(wc -c < google-credentials.json) bytes"
            # Validate JSON structure
            if node -e "JSON.parse(require('fs').readFileSync('google-credentials.json', 'utf8'))" 2>/dev/null; then
              echo "‚úì Credentials file is valid JSON"
              echo "‚úì Has 'private_key' field: $(node -e "console.log(!!JSON.parse(require('fs').readFileSync('google-credentials.json', 'utf8')).private_key)")"
            else
              echo "‚úó Credentials file is not valid JSON"
              exit 1
            fi
          else
            echo "‚úó Credentials file not found"
            exit 1
          fi

      - name: Create .env file
        run: |
          cat > .env << EOF
          PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CREDENTIALS_PATH=./google-credentials.json
          GOOGLE_DRIVE_FOLDER_ID=${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          EOF

      - name: Run sync
        id: sync
        run: |
          echo "Starting intelligent sync..."
          npm run sync-full 2>&1 | tee sync-output.log
          SYNC_EXIT=$?
          echo "exit_code=$SYNC_EXIT" >> $GITHUB_OUTPUT
          exit $SYNC_EXIT

      - name: Generate summary
        if: always()
        run: |
          echo "## üìä Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f sync-output.log ]; then
            # Extract key metrics from log
            NEW_COUNT=$(grep -oP 'NEW files: \K\d+' sync-output.log 2>/dev/null || echo "?")
            MOD_COUNT=$(grep -oP 'MODIFIED files: \K\d+' sync-output.log 2>/dev/null || echo "?")
            UNCHANGED_COUNT=$(grep -oP 'UNCHANGED files: \K\d+' sync-output.log 2>/dev/null || echo "?")

            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$NEW_COUNT" = "0" ]; then
              echo "- ‚úÖ **$NEW_COUNT NEW files** - All files already indexed" >> $GITHUB_STEP_SUMMARY
            else
              echo "- üìù **$NEW_COUNT NEW files** - Indexed successfully" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$MOD_COUNT" != "0" ] && [ "$MOD_COUNT" != "?" ]; then
              echo "- üîÑ **$MOD_COUNT MODIFIED files** - Updated since last sync" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚úÖ **$MOD_COUNT MODIFIED files** - No updates needed" >> $GITHUB_STEP_SUMMARY
            fi

            echo "- ‚è≠Ô∏è  **$UNCHANGED_COUNT UNCHANGED files** - Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show last 30 lines of detailed log
            echo "### Detailed Log (Last 30 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -30 sync-output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ Full logs available in artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Upload sync log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-log-${{ github.run_number }}
          path: sync-output.log
          retention-days: 30
          if-no-files-found: ignore

      - name: Cleanup credentials
        if: always()
        run: |
          rm -f google-credentials.json
          rm -f .env

      - name: Extract sync metrics
        if: always()
        id: metrics
        run: |
          if [ -f sync-output.log ]; then
            NEW_COUNT=$(grep -oP 'NEW files: \K\d+' sync-output.log 2>/dev/null || echo "0")
            MOD_COUNT=$(grep -oP 'MODIFIED files: \K\d+' sync-output.log 2>/dev/null || echo "0")
            SUCCESS_COUNT=$(grep -oP 'Success: \K\d+' sync-output.log 2>/dev/null || echo "0")
            FAILED_COUNT=$(grep -oP 'Failed: \K\d+' sync-output.log 2>/dev/null || echo "0")

            echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
            echo "mod_count=$MOD_COUNT" >> $GITHUB_OUTPUT
            echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
            echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT

            # Extract file list
            grep -A 1000 "NEW FILES TO INDEX" sync-output.log 2>/dev/null | head -50 > /tmp/new_files.txt || echo "None" > /tmp/new_files.txt
            grep -A 1000 "MODIFIED FILES TO RE-INDEX" sync-output.log 2>/dev/null | head -50 > /tmp/mod_files.txt || echo "None" > /tmp/mod_files.txt
          else
            echo "new_count=0" >> $GITHUB_OUTPUT
            echo "mod_count=0" >> $GITHUB_OUTPUT
            echo "success_count=0" >> $GITHUB_OUTPUT
            echo "failed_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "üìä Sally Sync Report - ${{ steps.metrics.outputs.success_count }} files synced"
          to: jobanjeet.s@commerceiq.ai
          from: Sally Sync Bot <${{ secrets.SMTP_USERNAME }}>
          body: |
            Sally Sales Enablement - Sync Report
            =====================================

            Run Date: ${{ github.event.head_commit.timestamp }}
            Status: ${{ job.status }}

            üìä SYNC RESULTS:

            ‚úÖ NEW files indexed: ${{ steps.metrics.outputs.new_count }}
            üîÑ MODIFIED files re-indexed: ${{ steps.metrics.outputs.mod_count }}
            ‚úÖ Total successful: ${{ steps.metrics.outputs.success_count }}
            ‚ùå Total failed: ${{ steps.metrics.outputs.failed_count }}

            ---

            View full logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            This is an automated message from Sally Sync Bot.

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Sync job failed. Check the logs for details."
