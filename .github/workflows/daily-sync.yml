name: Daily Pinecone Sync

on:
  schedule:
    # Run every day at 2 AM UTC (9 PM EST / 6 PM PST)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 120 # 2 hour timeout

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Create Google credentials file
        env:
          GOOGLE_CREDS: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
        run: |
          printf '%s\n' "$GOOGLE_CREDS" > google-credentials.json

      - name: Verify credentials file
        run: |
          if [ -f google-credentials.json ]; then
            echo "‚úì Credentials file created"
            echo "File size: $(wc -c < google-credentials.json) bytes"
            # Validate JSON structure
            if node -e "JSON.parse(require('fs').readFileSync('google-credentials.json', 'utf8'))" 2>/dev/null; then
              echo "‚úì Credentials file is valid JSON"
              echo "‚úì Has 'private_key' field: $(node -e "console.log(!!JSON.parse(require('fs').readFileSync('google-credentials.json', 'utf8')).private_key)")"
            else
              echo "‚úó Credentials file is not valid JSON"
              exit 1
            fi
          else
            echo "‚úó Credentials file not found"
            exit 1
          fi

      - name: Create .env file
        run: |
          cat > .env << EOF
          PINECONE_API_KEY=${{ secrets.PINECONE_API_KEY }}
          PINECONE_INDEX_NAME=${{ secrets.PINECONE_INDEX_NAME }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          GOOGLE_CREDENTIALS_PATH=./google-credentials.json
          GOOGLE_DRIVE_FOLDER_ID=${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          EOF

      - name: Run sync
        id: sync
        run: |
          echo "Starting intelligent sync..."
          npm run sync-full 2>&1 | tee sync-output.log
          SYNC_EXIT=$?
          echo "exit_code=$SYNC_EXIT" >> $GITHUB_OUTPUT
          exit $SYNC_EXIT

      - name: Generate summary
        if: always()
        run: |
          echo "## üìä Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f sync-output.log ]; then
            # Extract key metrics from log
            NEW_COUNT=$(grep -oP 'NEW files: \K\d+' sync-output.log 2>/dev/null || echo "?")
            MOD_COUNT=$(grep -oP 'MODIFIED files: \K\d+' sync-output.log 2>/dev/null || echo "?")
            UNCHANGED_COUNT=$(grep -oP 'UNCHANGED files: \K\d+' sync-output.log 2>/dev/null || echo "?")

            echo "### Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$NEW_COUNT" = "0" ]; then
              echo "- ‚úÖ **$NEW_COUNT NEW files** - All files already indexed" >> $GITHUB_STEP_SUMMARY
            else
              echo "- üìù **$NEW_COUNT NEW files** - Indexed successfully" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$MOD_COUNT" != "0" ] && [ "$MOD_COUNT" != "?" ]; then
              echo "- üîÑ **$MOD_COUNT MODIFIED files** - Updated since last sync" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ‚úÖ **$MOD_COUNT MODIFIED files** - No updates needed" >> $GITHUB_STEP_SUMMARY
            fi

            echo "- ‚è≠Ô∏è  **$UNCHANGED_COUNT UNCHANGED files** - Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Show last 30 lines of detailed log
            echo "### Detailed Log (Last 30 lines)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -30 sync-output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ Full logs available in artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Upload sync log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-log-${{ github.run_number }}
          path: sync-output.log
          retention-days: 30
          if-no-files-found: ignore

      - name: Cleanup credentials
        if: always()
        run: |
          rm -f google-credentials.json
          rm -f .env

      - name: Extract sync metrics
        if: always()
        id: metrics
        run: |
          if [ -f sync-output.log ]; then
            NEW_COUNT=$(grep -oP 'NEW files: \K\d+' sync-output.log 2>/dev/null || echo "0")
            MOD_COUNT=$(grep -oP 'MODIFIED files: \K\d+' sync-output.log 2>/dev/null || echo "0")
            SUCCESS_COUNT=$(grep -oP 'Success: \K\d+' sync-output.log 2>/dev/null || echo "0")
            FAILED_COUNT=$(grep -oP 'Failed: \K\d+' sync-output.log 2>/dev/null || echo "0")

            echo "new_count=$NEW_COUNT" >> $GITHUB_OUTPUT
            echo "mod_count=$MOD_COUNT" >> $GITHUB_OUTPUT
            echo "success_count=$SUCCESS_COUNT" >> $GITHUB_OUTPUT
            echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT

            # Extract file list
            grep -A 1000 "NEW FILES TO INDEX" sync-output.log 2>/dev/null | head -50 > /tmp/new_files.txt || echo "None" > /tmp/new_files.txt
            grep -A 1000 "MODIFIED FILES TO RE-INDEX" sync-output.log 2>/dev/null | head -50 > /tmp/mod_files.txt || echo "None" > /tmp/mod_files.txt
          else
            echo "new_count=0" >> $GITHUB_OUTPUT
            echo "mod_count=0" >> $GITHUB_OUTPUT
            echo "success_count=0" >> $GITHUB_OUTPUT
            echo "failed_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Generate HTML report
        if: always()
        run: |
          STATUS_COLOR="#28a745"
          STATUS_ICON="‚úÖ"
          if [ "${{ job.status }}" = "failure" ]; then
            STATUS_COLOR="#dc3545"
            STATUS_ICON="‚ùå"
          fi

          cat > sync-report.html << 'HTMLEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background: #f5f5f5; }
              .container { background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              h1 { color: #333; margin-bottom: 10px; }
              .status { display: inline-block; padding: 8px 16px; border-radius: 4px; color: white; font-weight: bold; margin-bottom: 20px; }
              .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
              .metric { background: #f8f9fa; padding: 20px; border-radius: 6px; border-left: 4px solid #007bff; }
              .metric-value { font-size: 32px; font-weight: bold; color: #333; }
              .metric-label { color: #666; font-size: 14px; margin-top: 5px; }
              .footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #666; font-size: 14px; }
              .link { color: #007bff; text-decoration: none; }
              .link:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üìä Sally Sales Enablement - Sync Report</h1>
              <div class="status" style="background-color: STATUS_COLOR;">STATUS_ICON Status: JOB_STATUS</div>

              <p><strong>Run Date:</strong> RUN_DATE UTC</p>

              <div class="metrics">
                <div class="metric">
                  <div class="metric-value">NEW_COUNT</div>
                  <div class="metric-label">‚úÖ NEW files indexed</div>
                </div>
                <div class="metric">
                  <div class="metric-value">MOD_COUNT</div>
                  <div class="metric-label">üîÑ MODIFIED files re-indexed</div>
                </div>
                <div class="metric">
                  <div class="metric-value">SUCCESS_COUNT</div>
                  <div class="metric-label">‚úÖ Total successful</div>
                </div>
                <div class="metric">
                  <div class="metric-value">FAILED_COUNT</div>
                  <div class="metric-label">‚ùå Total failed</div>
                </div>
              </div>

              <div class="footer">
                <p><a class="link" href="LOGS_URL">View full logs on GitHub ‚Üí</a></p>
                <p>This is an automated report from Sally Sync Bot</p>
              </div>
            </div>
          </body>
          </html>
          HTMLEOF

          # Replace placeholders
          sed -i "s|STATUS_COLOR|$STATUS_COLOR|g" sync-report.html
          sed -i "s|STATUS_ICON|$STATUS_ICON|g" sync-report.html
          sed -i "s|JOB_STATUS|${{ job.status }}|g" sync-report.html
          sed -i "s|RUN_DATE|$(date -u '+%Y-%m-%d %H:%M:%S')|g" sync-report.html
          sed -i "s|NEW_COUNT|${{ steps.metrics.outputs.new_count }}|g" sync-report.html
          sed -i "s|MOD_COUNT|${{ steps.metrics.outputs.mod_count }}|g" sync-report.html
          sed -i "s|SUCCESS_COUNT|${{ steps.metrics.outputs.success_count }}|g" sync-report.html
          sed -i "s|FAILED_COUNT|${{ steps.metrics.outputs.failed_count }}|g" sync-report.html
          sed -i "s|LOGS_URL|${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|g" sync-report.html

      - name: Upload HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-report-${{ github.run_number }}
          path: sync-report.html
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Sync job failed. Check the logs for details."
